# 小布 (Xiaobu) - 智能情绪聊天机器人

一个基于 Flask 的智能聊天机器人，具备情绪感知和动态情绪状态管理功能。小布是一位14岁的中国初中生，能够根据天气、聊天负载、作息时间、假期状态和用户情感智能调整自己的情绪状态。

## ✨ 核心特性

### 🎭 智能情绪系统
- **天气影响**: 基于武汉天气状况调整情绪（温度、天气条件、空气质量）
- **聊天负载**: 根据聊天频率动态调整压力水平
- **情感分析**: 实时分析用户对话中的积极/消极情绪
- **情绪表达**: 用 emoji 和简短文字表达当前情绪状态
- **动态变化**: 情绪值实时计算，支持多种情绪状态
- **时间感知**: 基于初中生作息时间调整情绪（睡眠、用餐、学习、娱乐时间）
- **青春期模拟**: 模拟青春期学生的荷尔蒙波动和情绪不稳定性
- **假期感知**: 根据中国学生假期（寒暑假、国庆等）调整工作积极性

### 🤖 智能对话
- **小布人格**：14岁初中生，就读于武汉市第三中学，具有真实的学生身份设定
- **身份一致性**：基于年龄、学校、兴趣爱好的完整身份体系
- **智能回复长度**：根据用户问题长度自动调整回复详细程度
  - 短消息（≤50字）：简短口语化回复，模拟日常聊天
  - 长消息（>50字）：详细回复，不受字数限制
- **全局记忆**：通过 `xiaobu.md` 配置小布的身份、风格和能力
- **上下文理解**：智能上下文管理，支持长时间连续对话
- **自动修剪**：当上下文超长时自动清理早期对话，保持性能
- **情绪引导回复**：每次回复都融入当前情绪状态，提供一致的人格体验

### 📱 移动端优化
- **响应式设计**：完美适配手机、平板等移动设备
- **直观界面**：用户消息显示在右侧，小布回复在左侧
- **实时反馈**：发送后立即显示"对方正在输入..."状态
- **情绪显示**：状态栏实时显示小布当前情绪 emoji
- **停止功能**：可随时中断 AI 思考过程

### 👥 多用户支持
- **独立会话**：基于浏览器指纹自动识别不同用户
- **隔离存储**：每个用户的对话数据完全独立
- **情绪独立**：每个用户的交互独立影响小布情绪
- **无需登录**：自动识别，无需注册或登录过程

### 📊 监控与分析
- **服务状态**: 实时监控 CPU、内存、磁盘使用率
- **情绪统计**: 详细的情绪分析数据和趋势统计
- **性能指标**: 请求计数、错误率、运行时间统计
- **实时推送**: 支持 SSE 实时状态和情绪数据推送

### 🔧 高级功能
- **对话历史**：保存完整对话记录，显示最近 42 条
- **上下文控制**：支持 `/clear` 命令或按钮清空上下文
- **错误处理**：网络错误自动重试，支持手动重新发送
- **调试信息**：后台提供详细的调试日志输出
- **身份系统**：完整的学生身份设定，包括学校、年级、兴趣爱好、学科偏好
- **假期系统**：中国学生假期日历，包括寒暑假、国庆节、期末考试等特殊时期

## 🚀 快速开始

### 环境要求
- Python 3.7+
- Claude CLI 工具已安装并配置

### 安装步骤

1. **克隆项目**
```bash
git clone <repository-url>
cd claude_webchat
```

2. **创建虚拟环境**
```bash
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows
```

3. **安装依赖**
```bash
pip install -r requirements.txt
```

4. **配置 Claude CLI**
确保已安装并配置好 Claude 命令行工具

5. **启动服务**
```bash
python app.py
```

6. **访问应用**
- 本地访问：http://127.0.0.1:8080
- 局域网访问：http://your-ip:8080

## 📝 使用指南

### 基本对话
- 在输入框中输入消息，支持多行文本
- 点击发送按钮或按 Enter 键发送
- 使用 Shift+Enter 换行

### 智能回复模式
- **简短聊天**：日常问候、简单问题会得到简洁的初中生式回复
- **深度对话**：当你发送超过50字的长消息时，小布会提供更详细的回答
- **自动切换**：系统根据消息长度自动选择合适的回复模式

### 上下文管理
- 点击右上角"清除上下文"按钮
- 或发送 `/clear` 命令
- 清除后保留历史记录，但重置对话上下文

### 停止对话
- 发送消息后，发送按钮变为红色停止按钮
- 点击可中断当前 AI 思考过程
- 支持重新发送被中断的消息

## 🔧 配置说明

### 小布人格配置
编辑 `xiaobu.md` 文件来自定义小布的：
- 身份设定和背景
- 对话风格和语气
- 能力范围和限制
- 特殊指令和注意事项

### 系统参数
在 `app.py` 中可调整：
```python
MAX_CONTEXT_LENGTH = 32000  # 最大上下文长度
MAX_CONTEXT_PAIRS = 30      # 最大保留对话轮数
```

## 📊 API 接口

### 基础功能
```
GET /                    # 主页面
POST /api/chat          # 发送消息
GET /api/history        # 获取聊天历史
```

### 情绪系统
```
GET /api/xiaobu/emotion     # 获取小布当前情绪状态
GET /api/emotions           # 获取情绪分析数据
GET /api/emotions/summary   # 获取情绪摘要统计
```

### 系统监控
```
GET /api/service-status     # 获取服务状态
GET /api/realtime/status    # 实时服务状态推送 (SSE)
GET /api/realtime/emotions  # 实时情绪数据推送 (SSE)
```

### 管理功能
```
GET /api/client-info        # 客户端信息
GET /api/context-info       # 上下文状态
GET/POST /api/global-memory # 全局记忆管理
```

### 情绪 API 示例

**获取小布情绪状态**
```bash
curl http://localhost:8080/api/xiaobu/emotion
```

响应示例：
```json
{
  "timestamp": "2025-07-15T07:01:44.254911",
  "emotion": "happy",
  "emoji": "😄",
  "reason": "天气不错",
  "emotion_value": 75,
  "factors": {
    "weather": 15,
    "chat_load": 5,
    "sentiment": 5,
    "base": 50
  },
  "weather": {
    "temperature": 22,
    "condition": "cloudy",
    "air_quality": 85
  },
  "chat_frequency_recent": 8,
  "total_chats_today": 25
}
```

## 🧠 情绪算法详解

### 情绪计算公式
```
总情绪值 = 基础情绪(50) + 天气因子 + 聊天负载因子 + 情感因子 + 时间因子 + 青春期因子
```

### 影响因子详解

#### 🌤️ 天气因子 (-20 到 +20)
- **温度影响**: 18-26°C 为舒适区间 (+10分)
- **天气状况**: 晴天 +15, 多云 +5, 雨天 -10, 雪天 -5
- **空气质量**: AQI ≤50 (+5分), AQI >150 (-10分)

#### 💬 聊天负载因子 (-15 到 +5)
- **高频聊天**: >30次/10分钟 (-15分, "感到疲劳")
- **频繁聊天**: >15次/10分钟 (-8分, "有些累")
- **适中频率**: 3-15次/10分钟 (+5分, "频率刚好")
- **低频聊天**: <3次/10分钟 (-5分, "感到无聊")

#### 😊 情感因子 (-15 到 +15)
- **积极情绪**: 每次积极对话 +3分
- **消极情绪**: 每次消极对话 -3分
- **基于最近10条对话的情感倾向**

#### ⏰ 时间因子 (-25 到 +15)
- **睡眠时间被打扰**: -25分，表现为犯困、烦躁 😴
- **用餐时间**: -10分，表现为饥饿状态 😋
- **学习时间**: +10分，表现为精力充沛 💪
- **周末户外活动**: +15分，表现为兴奋愉快 🚴
- **假期状态**: 学习任务 -15分，娱乐活动 +10分

#### 🧬 青春期因子 (-20 到 +20)
- **荷尔蒙波动**: 随机情绪波动，模拟青春期不稳定性
- **压力累积**: 学习压力、考试压力影响情绪基线
- **叛逆期影响**: 特定时期增加负面情绪倾向

### 特殊情绪状态
- **假期模式**: 寒暑假期间不愿学习工作，更偏向休闲娱乐
- **考试模式**: 考试期间压力增大，情绪更易波动
- **户外活动模式**: 周末表现出对骑车、露营、徒步的强烈兴趣

### 情绪等级
- **80-100分**: 很开心 😊 / 兴奋 🤩
- **65-79分**: 开心 😄 / 精力充沛 💪
- **45-64分**: 一般 😐 / 专注学习 📚
- **30-44分**: 有点难过 😢 / 疲倦 😴
- **0-29分**: 很难过 😭 / 极度烦躁 😠

## 🏗️ 技术架构

### 后端技术栈
- **Flask**：轻量级 Web 框架
- **Python 3**：主要开发语言
- **JSON 存储**：文件系统数据持久化
- **Claude CLI**：AI 对话核心
- **psutil**：系统性能监控
- **requests**：HTTP 请求处理

### 前端技术栈
- **原生 JavaScript**：无框架依赖
- **CSS3**：响应式布局和动画
- **HTML5**：语义化标记
- **Fetch API**：异步网络请求
- **Server-Sent Events**：实时数据推送

### 数据存储
```
claude_chatbot/
├── app.py                 # 主应用文件（包含小布身份和假期系统）
├── requirements.txt       # Python 依赖
├── templates/
│   └── index.html        # 前端界面（支持情绪显示和身份一致性）
├── chat_data/            # 聊天数据存储目录
│   └── chat_[client_id].json  # 各用户独立数据
├── xiaobu.md            # 全局记忆文件（小布人格配置）
└── venv/                # Python 虚拟环境
```

### 小布身份系统
```python
XIAOBU_IDENTITY = {
    'name': '小布',
    'age': 14,
    'grade': '初二',
    'school': '武汉市第三中学',
    'nationality': '中国',
    'location': '武汉',
    'birthday': '2010-03-15',
    'interests': ['骑车', '露营', '徒步', '游戏', '动漫', '篮球'],
    'subjects': {
        'favorite': ['体育', '美术'],
        'difficult': ['数学', '物理'],
        'okay': ['语文', '英语', '历史', '地理']
    }
}
```

### 假期日历系统
- **寒假**: 1月20日 - 2月25日（不想学习，想放松）
- **暑假**: 7月1日 - 8月31日（户外活动，抗拒功课）
- **国庆节**: 10月1日 - 10月7日（爱国情怀，休闲状态）
- **考试期**: 6月中旬、1月中旬（压力大，情绪不稳定）

## 🐛 调试功能

### 后台日志
启动后在控制台查看详细日志：
- 用户输入和 Bot 回复（截取前100字符）
- 上下文长度和修剪信息
- 请求时间和客户端信息

### 前端调试
浏览器控制台显示：
- 客户端 ID 和数据文件路径
- 上下文长度和使用情况
- 网络请求状态

## 🔒 安全考虑

- 基于浏览器特征的用户识别（非登录系统）
- 上下文自动修剪防止内存泄漏
- 用户数据隔离存储
- 敏感信息不记录日志

## 🤝 贡献指南

1. Fork 项目
2. 创建特性分支
3. 提交更改
4. 推送到分支
5. 创建 Pull Request

## 📄 许可证

MIT License

## 🆘 故障排除

### 常见问题

**Q: 提示"Claude 命令未找到"**
A: 确保已正确安装并配置 Claude CLI 工具

**Q: 对话无响应**
A: 检查网络连接和 Claude CLI 配置

**Q: 界面在移动端显示异常**
A: 清除浏览器缓存或尝试其他浏览器

**Q: 多个用户数据混乱**
A: 每个浏览器会自动创建独立的客户端 ID

### 获取帮助

- 检查控制台日志输出
- 访问 `/api/client-info` 查看客户端状态
- 访问 `/api/context-info` 查看上下文状态

---

**享受与小布的智能对话吧！** 🎉