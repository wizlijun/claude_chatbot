# 小布 - 智能对话助手

基于移动端优化的 Web 智能对话系统，集成 Claude AI，支持多用户独立会话和上下文管理。

## ✨ 核心特性

### 🤖 智能对话
- **小布人格**：友好的 AI 助手，具有独特的人格设定
- **全局记忆**：通过 `xiaobu.md` 配置小布的身份、风格和能力
- **上下文理解**：智能上下文管理，支持长时间连续对话
- **自动修剪**：当上下文超长时自动清理早期对话，保持性能

### 📱 移动端优化
- **响应式设计**：完美适配手机、平板等移动设备
- **直观界面**：用户消息显示在左侧，小布回复在右侧
- **实时反馈**：发送后立即显示"正在思考..."状态
- **停止功能**：可随时中断 AI 思考过程

### 👥 多用户支持
- **独立会话**：基于浏览器指纹自动识别不同用户
- **隔离存储**：每个用户的对话数据完全独立
- **无需登录**：自动识别，无需注册或登录过程

### 🔧 高级功能
- **对话历史**：保存完整对话记录，显示最近 42 条
- **上下文控制**：支持 `/clear` 命令或按钮清空上下文
- **错误处理**：网络错误自动重试，支持手动重新发送
- **调试信息**：后台提供详细的调试日志输出

## 🚀 快速开始

### 环境要求
- Python 3.7+
- Claude CLI 工具已安装并配置

### 安装步骤

1. **克隆项目**
```bash
git clone <repository-url>
cd claude_webchat
```

2. **创建虚拟环境**
```bash
python3 -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows
```

3. **安装依赖**
```bash
pip install -r requirements.txt
```

4. **配置 Claude CLI**
确保已安装并配置好 Claude 命令行工具

5. **启动服务**
```bash
python app.py
```

6. **访问应用**
- 本地访问：http://127.0.0.1:8080
- 局域网访问：http://your-ip:8080

## 📝 使用指南

### 基本对话
- 在输入框中输入消息，支持多行文本
- 点击发送按钮或按 Enter 键发送
- 使用 Shift+Enter 换行

### 上下文管理
- 点击右上角"清除上下文"按钮
- 或发送 `/clear` 命令
- 清除后保留历史记录，但重置对话上下文

### 停止对话
- 发送消息后，发送按钮变为红色停止按钮
- 点击可中断当前 AI 思考过程
- 支持重新发送被中断的消息

## 🔧 配置说明

### 小布人格配置
编辑 `xiaobu.md` 文件来自定义小布的：
- 身份设定和背景
- 对话风格和语气
- 能力范围和限制
- 特殊指令和注意事项

### 系统参数
在 `app.py` 中可调整：
```python
MAX_CONTEXT_LENGTH = 32000  # 最大上下文长度
MAX_CONTEXT_PAIRS = 30      # 最大保留对话轮数
```

## 📊 API 接口

### 对话接口
```
POST /api/chat
Content-Type: application/json
{
  "message": "你好小布"
}
```

### 历史记录
```
GET /api/history
```

### 调试接口
```
GET /api/client-info     # 客户端信息
GET /api/context-info    # 上下文状态
GET /api/global-memory   # 全局记忆内容
```

## 🏗️ 技术架构

### 后端技术栈
- **Flask**：轻量级 Web 框架
- **Python 3**：主要开发语言
- **JSON 存储**：文件系统数据持久化
- **Claude CLI**：AI 对话核心

### 前端技术栈
- **原生 JavaScript**：无框架依赖
- **CSS3**：响应式布局和动画
- **HTML5**：语义化标记
- **Fetch API**：异步网络请求

### 数据存储
```
chat_data/
├── chat_[client_id].json  # 各用户独立数据
xiaobu.md                  # 全局人格配置
```

## 🐛 调试功能

### 后台日志
启动后在控制台查看详细日志：
- 用户输入和 Bot 回复（截取前100字符）
- 上下文长度和修剪信息
- 请求时间和客户端信息

### 前端调试
浏览器控制台显示：
- 客户端 ID 和数据文件路径
- 上下文长度和使用情况
- 网络请求状态

## 🔒 安全考虑

- 基于浏览器特征的用户识别（非登录系统）
- 上下文自动修剪防止内存泄漏
- 用户数据隔离存储
- 敏感信息不记录日志

## 🤝 贡献指南

1. Fork 项目
2. 创建特性分支
3. 提交更改
4. 推送到分支
5. 创建 Pull Request

## 📄 许可证

MIT License

## 🆘 故障排除

### 常见问题

**Q: 提示"Claude 命令未找到"**
A: 确保已正确安装并配置 Claude CLI 工具

**Q: 对话无响应**
A: 检查网络连接和 Claude CLI 配置

**Q: 界面在移动端显示异常**
A: 清除浏览器缓存或尝试其他浏览器

**Q: 多个用户数据混乱**
A: 每个浏览器会自动创建独立的客户端 ID

### 获取帮助

- 检查控制台日志输出
- 访问 `/api/client-info` 查看客户端状态
- 访问 `/api/context-info` 查看上下文状态

---

**享受与小布的智能对话吧！** 🎉